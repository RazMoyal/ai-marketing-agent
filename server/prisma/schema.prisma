generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  currentOrgId String?
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  tz           String   @default("Asia/Jerusalem")
  locale       String   @default("he")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // back-relations ×§×™×™××™×
  connections   SocialConnection[]
  campaigns     Campaign[]
  leads         Lead[]
  competitors   Competitor[]
  notifications Notification[]

  // ğŸ”§ ×”×•×¡×¤×” â€“ ×¤×•×ª×¨×™× ××ª ×”×©×’×™××”:
  posts           Post[]
  recommendations Recommendation[]
  Membership      Membership[]
}

model SocialConnection {
  orgId        String?
  id           String   @id @default(cuid())
  userId       String
  platform     String // instagram|tiktok|facebook|whatsapp
  accessToken  String?
  refreshToken String?
  meta         Json?
  createdAt    DateTime @default(now())

  // ×™×—×¡×™×
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§ ×™×—×¡×™ ××¨×’×•×Ÿ

  @@unique([userId, platform], name: "userId_platform")
}

model Campaign {
  orgId     String?
  id        String    @id @default(cuid())
  userId    String
  name      String
  platform  String // instagram|tiktok|facebook
  objective String?
  budget    Float     @default(0)
  status    String    @default("draft") // draft|active|paused|completed
  startDate DateTime?
  endDate   DateTime?
  roi       Float?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // ×™×—×¡×™×
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  org   Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§
  leads Lead[]
}

model Lead {
  orgId      String?
  id         String   @id @default(cuid())
  userId     String
  campaignId String?
  name       String?
  phone      String?
  email      String?
  source     String? // campaign|post|form
  createdAt  DateTime @default(now())

  // ×™×—×¡×™×
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign?     @relation(fields: [campaignId], references: [id])
  org      Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§
}

model Competitor {
  orgId     String?
  id        String   @id @default(cuid())
  userId    String
  platform  String // instagram|tiktok|facebook
  handle    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // ××•×¤×¦×™×•× ×œ×™ ××‘×œ ××•××œ×¥

  // ×™×—×¡×™×
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§

  @@unique([userId, platform, handle], name: "userId_platform_handle") // ××•××œ×¥ ×œ×× ×•×¢ ×›×¤×™×œ×•×™×•×ª
}

model Recommendation {
  id        String   @id @default(cuid())
  userId    String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // ××•×¤×¦×™×•× ×œ×™ ××‘×œ ××•××œ×¥

  // ×™×—×¡×™×
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  orgId     String?
  id        String   @id @default(cuid())
  userId    String
  type      String // lead_new | campaign_alert | suggestion
  payload   Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // ×™×—×¡×™×
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§
}

model Post {
  orgId         String?
  attemptCount  Int       @default(0)
  nextAttemptAt DateTime?
  lastError     String?
  id            String    @id @default(cuid())
  userId        String
  text          String
  mediaUrl      String?
  platforms     Json
  scheduledAt   DateTime?
  status        String    @default("draft") // draft|scheduled|published|failed
  result        Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // ×™×—×¡×™×
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization? @relation(fields: [orgId], references: [id]) // ğŸ”§
}

model Organization {
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())

  users         Membership[]
  connections   SocialConnection[]
  posts         Post[]
  campaigns     Campaign[]
  leads         Lead[]
  competitors   Competitor[]
  notifications Notification[]
}

model Membership {
  id     String @id @default(cuid())
  userId String
  orgId  String
  role   String @default("owner")

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  orgId     String?
  action    String
  entity    String?
  meta      Json?
  createdAt DateTime @default(now())
}
